name: Build WebRTC 16KB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - cpu: arm64
            abi: arm64-v8a
          - cpu: arm
            abi: armeabi-v7a
          - cpu: x64
            abi: x86_64
          - cpu: x86
            abi: x86
    
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker system prune -af
          df -h
          
      - name: Setup depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git ~/depot_tools
          echo "$HOME/depot_tools" >> $GITHUB_PATH
          
      - name: Fetch WebRTC
        run: |
          mkdir ~/webrtc && cd ~/webrtc
          cat > .gclient << 'GCLIENT'
          solutions = [{"name": "src", "url": "https://webrtc.googlesource.com/src.git", "deps_file": "DEPS", "managed": False}]
          target_os = ["android"]
          GCLIENT
          gclient sync --nohooks --no-history --shallow
          
      - name: Install Dependencies
        run: |
          cd ~/webrtc/src
          ./build/install-build-deps.sh --no-prompt --android
          cd ~/webrtc && gclient runhooks
          
      - name: Build ${{ matrix.abi }}
        run: |
          cd ~/webrtc/src
          mkdir -p out/${{ matrix.abi }}
          cat > out/${{ matrix.abi }}/args.gn << 'ARGS'
          target_os = "android"
          target_cpu = "${{ matrix.cpu }}"
          is_debug = false
          rtc_include_tests = false
          rtc_build_examples = false
          rtc_build_tools = false
          ARGS
          gn gen out/${{ matrix.abi }}
          
          # Build native library AND Java SDK
          ninja -C out/${{ matrix.abi }} libjingle_peerconnection_so sdk/android:libwebrtc
          
      - name: Verify & Prepare Artifacts
        run: |
          cd ~/webrtc/src/out/${{ matrix.abi }}
          
          echo "=== Native Library ==="
          ls -la libjingle_peerconnection_so.so
          readelf -l libjingle_peerconnection_so.so | head -20
          
          echo ""
          echo "=== Looking for JAR files ==="
          find . -name "*.jar" -type f 2>/dev/null || true
          find . -name "libwebrtc*" -type f 2>/dev/null || true
          
          # Prepare output directory
          mkdir -p /tmp/output/${{ matrix.abi }}
          cp libjingle_peerconnection_so.so /tmp/output/${{ matrix.abi }}/
          
          # Find and copy JAR file
          JAR_PATH=""
          for path in \
            "lib.java/sdk/android/libwebrtc.jar" \
            "obj/sdk/android/libwebrtc.jar" \
            "libwebrtc.jar"; do
            if [ -f "$path" ]; then
              JAR_PATH="$path"
              break
            fi
          done
          
          if [ -z "$JAR_PATH" ]; then
            JAR_PATH=$(find . -name "libwebrtc.jar" -type f 2>/dev/null | head -1)
          fi
          
          if [ -n "$JAR_PATH" ] && [ -f "$JAR_PATH" ]; then
            cp "$JAR_PATH" /tmp/output/${{ matrix.abi }}/libwebrtc.jar
            echo "✅ JAR found at: $JAR_PATH"
          else
            echo "⚠️ JAR not found"
          fi
          
          ls -la /tmp/output/${{ matrix.abi }}/
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-${{ matrix.abi }}
          path: /tmp/output/${{ matrix.abi }}/
          retention-days: 90

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: libs
          
      - name: Package All
        run: |
          mkdir -p jniLibs libs_jar
          
          # Copy native libraries
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            mkdir -p jniLibs/$abi
            cp libs/webrtc-$abi/*.so jniLibs/$abi/ 2>/dev/null || true
          done
          
          # Copy JAR (only need one since Java is ABI-independent)
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -f "libs/webrtc-$abi/libwebrtc.jar" ]; then
              cp "libs/webrtc-$abi/libwebrtc.jar" libs_jar/
              echo "✅ Copied libwebrtc.jar from $abi"
              break
            fi
          done
          
          echo ""
          echo "=== Native Libraries ==="
          ls -laR jniLibs/
          echo ""
          echo "=== Java JAR ==="
          ls -la libs_jar/ 2>/dev/null || echo "No JAR found"
          
      - name: Upload Native Libraries
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-16kb-all-abis
          path: jniLibs/
          retention-days: 90
          
      - name: Upload Java JAR
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-libwebrtc-jar
          path: libs_jar/
          retention-days: 90
          if-no-files-found: warn
